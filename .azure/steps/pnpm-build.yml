steps:
  - task: Cache@2
    inputs:
      key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
      path: $(pnpm_config_cache)
    displayName: Cache pnpm

  - script: |
      corepack enable
      corepack prepare pnpm@latest-8 --activate
      pnpm config set store-dir $(pnpm_config_cache)
    displayName: "Setup pnpm"

  - script: pnpm install
    displayName: "pnpm install"
  - script: pnpm lint
    displayName: "pnpm lint"
  - script: pnpm build
    displayName: "pnpm build"

  - script: |
      tar --exclude='node_modules' -czvf $(Build.ArtifactStagingDirectory)/artifacts.tar.gz ./* .[!.]*
    displayName: "Compress build"

  - publish: $(Build.ArtifactStagingDirectory)/artifacts.tar.gz
    artifact: $(artifactName)