steps:
  - task: Cache@2
    inputs:
      key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
      path: $(pnpm_config_cache)
    displayName: Cache pnpm

  - script: |
      corepack enable
      corepack prepare pnpm@latest-8 --activate
      pnpm config set store-dir $(pnpm_config_cache)
    displayName: "Setup pnpm"

  - task: ReplaceTokens@1
    inputs:
      targetFiles: '["apps/server/.env.template", "apps/web/.env.template"]'
      tokenPrefix: '{'
      tokenSuffix: '}'
      encoding: 'auto'
      writeBOM: false
      actionOnMissing: 'warn'
      keepToken: false
      tokenizerType: 'json'
      enableTelemetry: true
    displayName: "Replace tokens"

  - script: |
      mv apps/server/.env.template apps/server/.env
      mv apps/web/.env.template apps/web/.env

  - script: pnpm install
    displayName: "pnpm install"
  - script: pnpm lint
    displayName: "pnpm lint"
  - script: pnpm build
    displayName: "pnpm build"

  - script: |
      tar --exclude='node_modules' -czvf $(Build.ArtifactStagingDirectory)/artifacts.tar.gz ./* .[!.]*
    displayName: "Compress build"

  - publish: $(Build.ArtifactStagingDirectory)/artifacts.tar.gz
    artifact: $(artifactName)